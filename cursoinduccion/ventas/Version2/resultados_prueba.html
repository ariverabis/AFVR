<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVF - Productos (Prueba)</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 400px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 20px;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
        }
        .header .title {
            display: flex;
            align-items: center;
        }
        .header .title img {
            height: 25px;
            margin-right: 10px;
        }
        .guia {
            background-color: #e0f7fa;
            border-left: 5px solid #007bff;
            padding: 15px;
            margin: 10px 20px;
            color: #333;
            font-size: 0.9em;
        }
        .help-message-container {
            background-color: #fff3cd; /* Color de fondo para alerta de ayuda */
            border-left: 5px solid #ffc107; /* Borde izquierdo de color amarillo */
            padding: 15px;
            margin: 10px 20px;
            color: #664d03;
            font-size: 0.9em;
        }
        .search-bar {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            gap: 5px;
            margin-top: 15px;
        }
        .search-bar .search-label {
            font-weight: bold;
            color: #555;
            flex-shrink: 0;
        }
        .search-bar input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .search-bar button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            background-color: #d3d3d3;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        .product-list {
            height: 300px;
            overflow-y: scroll;
            margin: 10px 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .product-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .product-item:last-child {
            border-bottom: none;
        }
        .product-item:hover {
            background-color: #e9e9e9;
        }
        .product-item input[type="checkbox"] {
            margin-right: 10px;
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 1px solid #ccc;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
        }
        .product-item input[type="checkbox"]:checked {
            background-color: #007bff;
            border-color: #007bff;
        }
        .product-item input[type="checkbox"]:checked::before {
            content: '✓';
            color: white;
            font-size: 14px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .product-item.selected {
            background-color: #e6f2ff;
        }
        .product-details-text {
            display: flex;
            flex-direction: column;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .product-details-text .code {
            font-weight: bold;
            font-size: 0.9em;
        }
        .product-details-text .description {
            font-size: 0.8em;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .product-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .field-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .field-group label {
            font-weight: bold;
            font-size: 0.8em;
            width: 50px;
            flex-shrink: 0;
        }
        .product-details input {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: right;
            background-color: #e9e9e9;
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
        }
        .bottom-nav {
            display: flex;
            justify-content: flex-end;
            padding: 20px;
            border-top: 1px solid #ddd;
        }
        .bottom-nav button {
            padding: 15px 30px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            margin-left: 10px;
        }
        .bottom-nav .back-button {
            background-color: #6c757d;
        }
        .bottom-nav .ok-button {
            background-color: #007bff;
        }
        
        /* Tooltip styles */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: fixed;
            top: var(--tooltip-top);
            left: var(--tooltip-left);
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1000;
            pointer-events: none;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="title">
            <img src="logofebeca.png" alt="Logo">
            <span>080 - Productos</span>
        </div>
        <div class="options" data-tooltip="Opciones de menú..." onclick="mostrarAyudaGeneral()">...</div>
    </div>
    
    <div class="help-message-container">
        <b>Guía de Uso:</b>
        <p>1. Ingrese el código o parte del nombre del producto en el campo de búsqueda y presione 'Enter' o el botón 'B.'.</p>
        <p>2. Seleccione un producto de la lista para ver sus detalles.</p>
        <p>3. Ingrese la cantidad deseada en el campo 'Cant.' (debe ser un múltiplo de Emp. C.).</p>
        <p>4. Presione el botón 'OK' para agregar el producto al pedido.</p>
    </div>

    <div class="search-bar">
        <span class="search-label">Buscar</span>
        <input type="text" placeholder="Código o nombre..." id="busqueda-producto" onkeyup="if(event.key === 'Enter') buscarProducto()">
        <button type="button" onclick="buscarProducto()">B.</button>
        <button type="button" onclick="window.open('datos.html', 'DatosDelPedido', 'width=300,height=400');">Sub</button>
    </div>
    
    <div class="product-list" id="lista-productos">

        <div class="product-item" data-codigo="0101002" data-nombre="Receptaculo De Pvc Blanco Bornes Automaticos Btincino - 7110502" data-precio="3.86" data-existencia="450" data-empaque="10" onclick="seleccionarProducto(this)">
            <input type="checkbox" name="producto" value="0101002" id="prod-0101002">
            <div class="product-details-text">
                <span class="code">0101002</span>
                <span class="description">Receptaculo De Pvc Blanco Bornes Automaticos Btincino - 7110502</span>
            </div>
        </div>
        <div class="product-item" data-codigo="0101007" data-nombre="Socate metalico e27 para intemperie Eagle - 7130165" data-precio="5.35" data-existencia="210" data-empaque="6" onclick="seleccionarProducto(this)">
            <input type="checkbox" name="producto" value="0101007" id="prod-0101007">
            <div class="product-details-text">
                <span class="code">0101007</span>
                <span class="description">Socate metalico e27 para intemperie Eagle - 7130165</span>
            </div>
        </div>
        <div class="product-item" data-codigo="0101012" data-nombre="Socate de porcelana e-27 Fermetal - 7130011" data-precio="1.50" data-existencia="1500" data-empaque="12" onclick="seleccionarProducto(this)">
            <input type="checkbox" name="producto" value="0101012" id="prod-0101012">
            <div class="product-details-text">
                <span class="code">0101012</span>
                <span class="description">Socate de porcelana e-27 Fermetal - 7130011</span>
            </div>
        </div>
        <div class="product-item" data-codigo="0101014" data-nombre="Socate para tubo LED T8 y tubo fluorescente Gdeseo - 7300315" data-precio="2.15" data-existencia="75" data-empaque="1" onclick="seleccionarProducto(this)">
            <input type="checkbox" name="producto" value="0101014" id="prod-0101014">
            <div class="product-details-text">
                <span class="code">0101014</span>
                <span class="description">Socate para tubo LED T8 y tubo fluorescente Gdeseo - 7300315</span>
            </div>
        </div>
        <div class="product-item" data-codigo="0101018" data-nombre="Balasto electrónico 2 x 60 w luz blanca Philips - 7025097" data-precio="8.75" data-existencia="30" data-empaque="2" onclick="seleccionarProducto(this)">
            <input type="checkbox" name="producto" value="0101018" id="prod-0101018">
            <div class="product-details-text">
                <span class="code">0101018</span>
                <span class="description">Balasto electrónico 2 x 60 w luz blanca Philips - 7025097</span>
            </div>
        </div>
        <div class="product-item" data-codigo="0101021" data-nombre="Socate plástico rosca E27 blanco Semilic - 7130077" data-precio="0.95" data-existencia="1250" data-empaque="20" onclick="seleccionarProducto(this)">
            <input type="checkbox" name="producto" value="0101021" id="prod-0101021">
            <div class="product-details-text">
                <span class="code">0101021</span>
                <span class="description">Socate plástico rosca E27 blanco Semilic - 7130077</span>
            </div>
        </div>
        <div class="product-item" data-codigo="0101024" data-nombre="Socate de porcelana rosca E27 modelo 11 Amperios Semilic - 7130101" data-precio="2.30" data-existencia="850" data-empaque="4" onclick="seleccionarProducto(this)">
            <input type="checkbox" name="producto" value="0101024" id="prod-0101024">
            <div class="product-details-text">
                <span class="code">0101024</span>
                <span class="description">Socate de porcelana rosca E27 modelo 11 Amperios Semilic - 7130101</span>
            </div>
        </div>

    </div>
    
    <div class="product-details">
        <div class="field-group">
            <label>P1:</label>
            <input type="text" id="precio-p1" value="0,00" readonly title="Precio de la lista 1 (P1). Haga clic para ver detalles." onclick="window.open('Precios.html', 'ConsultaPrecios', 'width=380,height=600');">
        </div>
        <div class="field-group">
            <label>P2:</label>
            <input type="text" id="precio-p2" value="0,00" readonly title="Precio de la lista 2 (P2). Haga clic para ver detalles." onclick="window.open('Precios2.html', 'ConsultaPrecios2', 'width=380,height=600');">
        </div>

        <div class="field-group">
            <label for="u-inv">U. Inv.:</label>
            <input type="text" id="u-inv" value="1 PZA" readonly title="Unidad de Inventario: Cómo se contabiliza el producto en el almacén.">
        </div>
        <div class="field-group">
            <label for="emp-c">Emp. C.:</label>
            <input type="text" id="emp-c" value="0" readonly title="Empaque Comercial: La unidad mínima en la que se vende el producto.">
        </div>

        <div class="field-group">
            <label for="c-min">C. Min.:</label>
            <input type="text" id="c-min" value="0.0" readonly title="Cantidad mínima de pedido.">
        </div>
        <div class="field-group">
            <label for="dscto">Dscto.:</label>
            <input type="text" id="dscto" value="0.0" readonly title="Descuento aplicado al producto.">
        </div>
        
        <div class="field-group">
            <label for="exist">Exist:</label>
            <input type="text" id="exist" value="0.0" readonly title="Existencia actual del producto en el inventario.">
        </div>
        <div class="field-group">
            <label for="cant">Cant.:</label>
            <input type="text" id="cant" title="Ingrese la cantidad a pedir. Debe ser un múltiplo de la cantidad en Emp. C.">
        </div>
        
    </div>

    <div class="bottom-nav">
        <button type="button" class="back-button" title="Volver a la pantalla anterior para ver el pedido." onclick="window.location.href='detallepedido_prueba.html';">Regresar</button>
        <button type="button" class="ok-button" title="Guarda la cantidad del producto seleccionado y lo añade al pedido." onclick="agregarProducto()">OK</button>
    </div>
</div>

<script>
    // Lógica para el tooltip, sin cambios
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-tooltip]').forEach(item => {
            item.addEventListener('mouseenter', (event) => {
                const rect = event.target.getBoundingClientRect();
                const tooltipText = item.getAttribute('data-tooltip');
                const tooltipWidth = tooltipText.length * 6;
                
                let leftPosition = rect.left + (rect.width / 2);
                let topPosition = rect.top;

                if (leftPosition - tooltipWidth / 2 < 0) {
                    leftPosition = tooltipWidth / 2 + 10;
                } else if (leftPosition + tooltipWidth / 2 > window.innerWidth) {
                    leftPosition = window.innerWidth - tooltipWidth / 2 - 10;
                }
                
                if (topPosition < 50) { 
                    item.style.setProperty('--tooltip-top', `${topPosition + rect.height + 5}px`);
                } else {
                    item.style.setProperty('--tooltip-top', `${topPosition - 5}px`);
                }
                
                item.style.setProperty('--tooltip-left', `${leftPosition}px`);
            });
        });
    });

    /**
     * Busca y selecciona un producto en la lista por su código o nombre.
     */
    function buscarProducto() {
        const busquedaInput = document.getElementById('busqueda-producto');
        const searchTerm = busquedaInput.value.trim().toLowerCase();
        
        if (searchTerm === '') {
            alert('Por favor, ingrese un código o nombre para buscar.');
            return;
        }

        const productItems = document.querySelectorAll('.product-item');
        let encontrado = false;
        let productoASeleccionar = null;

        productItems.forEach(item => {
            const codigo = item.getAttribute('data-codigo').toLowerCase();
            const nombre = item.getAttribute('data-nombre').toLowerCase();
            
            if (codigo.includes(searchTerm) || nombre.includes(searchTerm)) {
                // Almacena el primer producto que coincida
                if (!productoASeleccionar) {
                    productoASeleccionar = item;
                }
                encontrado = true;
            }
        });

        if (productoASeleccionar) {
            seleccionarProducto(productoASeleccionar);
            // Desplazar la vista para que el elemento sea visible
            productoASeleccionar.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            alert('Producto no encontrado.');
        }
    }

    /**
     * Selecciona un producto de la lista y actualiza los campos de detalles.
     * @param {HTMLElement} elemento - El elemento div del producto seleccionado.
     */
    function seleccionarProducto(elemento) {
        // Si el elemento ya está seleccionado, no hacer nada
        if (elemento.classList.contains('selected')) {
            return;
        }

        document.querySelectorAll('.product-item').forEach(item => {
            item.classList.remove('selected');
            item.querySelector('input[type="checkbox"]').checked = false;
        });

        elemento.classList.add('selected');
        elemento.querySelector('input[type="checkbox"]').checked = true;

        // Obtener los datos del atributo del producto
        const precioP1 = parseFloat(elemento.getAttribute('data-precio'));
        const existencia = parseFloat(elemento.getAttribute('data-existencia'));
        const empaqueComercial = parseFloat(elemento.getAttribute('data-empaque'));

        // Calcular el precio P2 (P1 + 20%)
        const precioP2 = precioP1 * 1.20;

        // Actualizar los campos de precio, existencia y empaque en el formulario
        document.getElementById('precio-p1').value = precioP1.toFixed(2).replace('.', ',');
        document.getElementById('precio-p2').value = precioP2.toFixed(2).replace('.', ',');
        document.getElementById('exist').value = existencia;
        document.getElementById('emp-c').value = empaqueComercial;
        document.getElementById('cant').value = ''; // Limpiar el campo de cantidad
    }

    /**
     * Agrega el producto seleccionado al pedido.
     */
    function agregarProducto() {
        const productoSeleccionado = document.querySelector('.product-item.selected');
        const cantidadInput = document.getElementById('cant');
        
        if (!productoSeleccionado) {
            alert('Por favor, seleccione un producto de la lista.');
            return;
        }

        const cantidad = parseInt(cantidadInput.value);
        const empaqueComercial = parseInt(productoSeleccionado.getAttribute('data-empaque'));

        if (isNaN(cantidad) || cantidad <= 0) {
            alert('Por favor, ingrese una cantidad válida.');
            return;
        }
        
        if (cantidad % empaqueComercial !== 0) {
            alert('La cantidad debe ser un múltiplo del empaque comercial (' + empaqueComercial + ').');
            return;
        }
        
        const codigo = productoSeleccionado.getAttribute('data-codigo');
        const nombre = productoSeleccionado.getAttribute('data-nombre');
        const precio = parseFloat(productoSeleccionado.getAttribute('data-precio'));
        
        const nuevoProducto = {
            codigo: codigo,
            nombre: nombre,
            cantidad: cantidad,
            precio: precio,
            subtotal: (cantidad * precio)
        };

        let productosEnPedido = JSON.parse(localStorage.getItem('productosEnPedido_prueba')) || [];
        productosEnPedido.push(nuevoProducto);
        
        localStorage.setItem('productosEnPedido_prueba', JSON.stringify(productosEnPedido));

        alert('Producto agregado al pedido. Puede seguir agregando más productos.');
        
        cantidadInput.value = '';
        productoSeleccionado.classList.remove('selected');
        productoSeleccionado.querySelector('input[type="checkbox"]').checked = false;
    }

    /**
     * Muestra la ventana de ayuda general.
     */
    function mostrarAyudaGeneral() {
        const ayudaUrl = 'ayuda_general.html'; // Puedes crear un archivo HTML para la ayuda general
        const ayudaContenido = `
            <h1>Ayuda General del Sistema</h1>
            <p>Este sistema de gestión de productos le permite consultar precios, existencias y crear pedidos de manera eficiente.</p>
            <h3>Funcionalidades Clave:</h3>
            <ul>
                <li><b>Búsqueda Rápida:</b> Utilice el campo "Buscar" para encontrar productos por código o nombre.</li>
                <li><b>Detalles del Producto:</b> Al seleccionar un producto, podrá ver su precio, existencia, empaque y otros datos importantes.</li>
                <li><b>Pedido:</b> Ingrese la cantidad deseada y haga clic en "OK" para añadir el producto a su pedido.</li>
                <li><b>Consulta de Precios:</b> Los campos P1 y P2 le permiten abrir una ventana detallada con la información de precios.</li>
            </ul>
            <p>Para más información, contacte al administrador del sistema.</p>
        `;
        const ayudaWindow = window.open('', 'AyudaGeneral', 'width=450,height=500,resizable=yes,scrollbars=yes');
        ayudaWindow.document.write(ayudaContenido);
        ayudaWindow.document.close();
    }
</script>

</body>
</html>